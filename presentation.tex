\documentclass[aspectratio=169]{beamer}
\mode<presentation>

\usepackage{tikz}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{fit}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{shadows}
\usetikzlibrary{tikzmark}

\title{Stack Graphs}
\author{Douglas Creager}
\institute{GitHub}
\date{Strange Loop 2021}

\setbeamertemplate{navigation symbols}{}

\usepackage{minted}
\usemintedstyle{colorful}

\usepackage{fontspec}
\setsansfont{Arial}
\setmonofont[Scale=0.8]{Iosevka Term}

\newlength{\scopegap}
\setlength{\scopegap}{0.9cm}

\definecolor{sgdef}  {RGB}{159,0,0}
\definecolor{sgpop}  {RGB}{230,142,131}
\definecolor{sgref}  {RGB}{0,134,67}
\definecolor{sgpush} {RGB}{131,216,173}
\definecolor{sgjump} {RGB}{161,64,140}

\tikzset{root node/.style={
    node distance=0.5cm,
    circle, fill=black, inner sep=0pt,
    minimum size=0.35cm
}}

\tikzset{anon scope/.style={
    node distance=0.5cm,
    circle, fill=white, inner sep=0pt,
    draw=black, semithick,
    minimum size=0.35cm
}}

\tikzset{named scope/.style={
    node distance=0.5cm,
    circle, fill=white,
    draw=black, thick,
    minimum size=0.35cm
}}

\tikzset{exported scope/.style={
    node distance=0.5cm,
    circle, fill=white,
    draw=sgjump, thick, text=sgjump,
    minimum size=0.35cm
}}

\tikzset{symbol text/.style={
    fill=white,
    text height=1.5ex, text depth=0.25ex, node font=\ttfamily,
    inner xsep=7pt,
    minimum size=0.75cm,
}}

\tikzset{definition/.style={
    node distance=0.5cm,
    draw=sgdef, semithick, double, double distance=1pt, outer sep=1pt,
    text=sgdef, symbol text,
}}

\tikzset{pop/.style={
    node distance=0.5cm,
    rectangle split,
    rectangle split parts=2,
    rectangle split horizontal,
    rectangle split draw splits=false,
    rectangle split ignore empty parts,
    draw=sgpop, thick, dash dot,
    text=sgpop, symbol text,
}}
\newcommand{\popscope}{
    \nodepart{two}
    \hspace{-12pt}
    \tikz \node [circle, fill=sgjump, inner sep=0pt, minimum size=0.25cm] {};
}

\tikzset{reference/.style={
    node distance=0.5cm,
    draw=sgref, thick,
    text=sgref, symbol text,
}}

\tikzset{push/.style={
    node distance=0.5cm,
    rectangle split,
    rectangle split parts=2,
    rectangle split horizontal,
    rectangle split draw splits=false,
    rectangle split ignore empty parts,
    draw=sgpush, thick, densely dashed,
    text=sgpush, symbol text,
}}
\newcommand{\pushscope}[1]{
    \nodepart{two}
    \hspace{-12pt}
    \tikz \node [
        circle, fill=white,
        draw=sgjump,
        text=sgjump, inner sep=2pt,
        minimum size=0.25cm
    ] {\tiny #1};
}

\newcommand{\widestsymbol}{}
\newcommand{\setwidestsymbol}[1]{\renewcommand{\widestsymbol}{#1}}
\newcommand{\sized}[2][\widestsymbol]{\makebox[\widthof{#1}]{#2}}

\tikzset{
  alt/.code args={<#1>#2#3}{%
    \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
  }
}

\tikzset{
    highlight node/.style={
        general shadow={fill=blue, opacity=0.3},
        shadow scale=1.2, shadow xshift=0pt, shadow yshift=0pt
    }
}
\tikzset{
    highlight node on/.code args={<#1>}{%
        \alt<#1>{\pgfkeysalso{highlight node}}{}%
    }
}

% Animating paths in a stack graph picture
%   Just add [highlighted on=<slide>] to an edge's style.  The line of the edge
%   will be blue and extra thick on <slide> AND ALL LATER SLIDES.  It will have
%   an arrowhead on SLIDE.
%
%   Together, this means that you add this to all of the edges that comprise a
%   path, with increasing <slide> values for each one, and beamer will create an
%   overlay animation showing the edges of the path get highlighted in order
%   each time you advance to the next slide.
\tikzset{highlight edge/.style={line width=2pt, blue, -}}
\tikzset{highlight edge frontier/.style={-{Triangle[length=4pt,width=4pt]}}}
\tikzset{
    show path on/.code args={<#1>}{%
        \alt<#1- >{\pgfkeysalso{highlight edge}}{}%
        \alt<#1  >{\pgfkeysalso{highlight edge frontier}}{}%
    }
}

\tikzset{binding arrow/.style={->, red, thick, -{Triangle[]}}}

\newcommand{\codeline}[3][]{%
    \tikz[remember picture] \draw [overlay, binding arrow, #1] (#2) -- (#3);%
}

\newcommand{\curvecodeline}[4][]{%
    \tikz[remember picture] \draw [overlay, binding arrow, #1] (#2) .. controls #3 .. (#4);%
}

\begin{document}

\begin{frame}
    \titlepage
\end{frame}


% easy
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def broil?\tikzmark{easy_broil_def}?():
            pass

        def saute():
            pass

        broil?\tikzmark{easy_broil_ref}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<2>{\curvecodeline%
      {[yshift=8pt] pic cs:easy_broil_ref}%
      {+(25:2cm) and +(-45:1cm)}%
      {[yshift=-4pt] pic cs:easy_broil_def}%
    }%
\end{frame}


% easy_shadowed
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def broil?\tikzmark{easy_shadowed_broil_def1}?():
            pass

        def broil?\tikzmark{easy_shadowed_broil_def2}?():
            pass

        def saute():
            pass

        broil?\tikzmark{easy_shadowed_broil_ref}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<2>{\curvecodeline%
      [dotted]%
      {[yshift=8pt] pic cs:easy_shadowed_broil_ref}%
      {+(15:3cm) and +(-35:1cm)}%
      {[yshift=-4pt] pic cs:easy_shadowed_broil_def1}%
    }%
    \uncover<2>{\curvecodeline%
      {[yshift=8pt] pic cs:easy_shadowed_broil_ref}%
      {+(25:2cm) and +(-45:1cm)}%
      {[yshift=-4pt] pic cs:easy_shadowed_broil_def2}%
    }%
\end{frame}


% easy_shadowed_rust
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.rs,escapeinside=??]{rust}
        fn broil() {}

        fn broil?\tikzmark{easy_shadowed_rust_broil_def2}?() {}

        fn saute() {}

        fn main() {
          broil();
        }
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<2>{%
        \tikz[remember picture]
          \node [overlay, text=red]
            at ([xshift=-2ex, yshift=0.5ex] pic cs:easy_shadowed_rust_broil_def2)
            {\textbf{\Huge X}};%
    }%
\end{frame}


% separate_files
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}[t]{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def broil?\tikzmark{separate_files_broil_def}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{separate_files_broil_import}?broil

        broil?\tikzmark{separate_files_broil_ref}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<2>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:separate_files_broil_ref}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:separate_files_broil_import}%
    }
    \uncover<2>{\curvecodeline%
      {[xshift=12pt, yshift=10pt] pic cs:separate_files_broil_import}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:separate_files_broil_def}%
    }
\end{frame}


% separate_files_star
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}[t]{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def broil?\tikzmark{separate_files_star_broil_def}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{separate_files_star_import}?*

        broil?\tikzmark{separate_files_star_broil_ref}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<2>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:separate_files_star_broil_ref}%
      {+(45:1cm) and +(-105:1cm)}%
      {[xshift=1pt, yshift=-2pt] pic cs:separate_files_star_import}%
    }
    \uncover<2>{\curvecodeline%
      {[xshift=3pt, yshift=10pt] pic cs:separate_files_star_import}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:separate_files_star_broil_def}%
    }
\end{frame}


\begin{frame}
    \begin{center}
        \begin{tikzpicture}
            \draw [help lines] (0,0) grid (10,8);

            \node (root)   [root node]       at(1,1)  {};
            \node (s0)     [anon scope]      at(2,1)  {};
            \node (sB)     [named scope]     at(3,1)  {B};
            \node (s7)     [exported scope]  at(4,1)  {7};
            \node (A)      [definition]      at(1,2)  {A};

            \node (a)      [definition]  [right=of A] {a};
            \node (A2)     [pop]         [above=of A] {A\textsubscript{2}};
            \node (main2)  [pop]         [right=of A2] {\_\_main\_\_\textsubscript{2}};
            \node (bar)    [pop]         [right=of main2] {A\textsubscript{3} \popscope};

            \node (A3)     [reference]  [above=of A2] {A};
            \node (a3)     [reference]  [right=of A3] {a};
            \node (A4)     [push]       [above=of A3] {A\textsubscript{4}};
            \node (main4)  [push]       [right=of A4] {\_\_main\_\_\textsubscript{4}};
            \node (foo)    [push]       [right=of main4] {A\textsubscript{3} \pushscope{7}};

            % edges
            \path [-Stealth]
              (root) edge (A)
              (A) edge (a)
                  edge (A2)
              (a) edge (main2)
              ;
        \end{tikzpicture}
    \end{center}
\end{frame}

\begin{frame}[fragile]
    \begin{columns}
    \begin{column}{0.3\textwidth}
        \begin{minted}[autogobble,frame=single,framesep=6pt,label=a.py,escapeinside=??]{python}
            def broil?\tikzmark{testbroildef}?():
                pass

            def fry():
                pass

            broil?\tikzmark{testbroilref}?()
        \end{minted}
        \uncover<1>  {\curvecodeline{[yshift=8pt] pic cs:testbroilref}{+(25:2cm) and +(-45:1cm)}{[yshift=-4pt] pic cs:testbroildef}} \uncover<2- >{\codeline{pic cs:testbroilref}{pic cs:testbroildef}}
    \end{column}

    \begin{column}{0.7\textwidth}
        \begin{center}
        \begin{tikzpicture}
            \node (root)       [root node]                            {};
            \node (a)          [definition]  [right=of root]          {a};
            \node (dot)        [pop]         [right=of a]             {.};
            \node (s1)         [anon scope]  [right=of dot]           {};

            \setwidestsymbol{broil}
            \node (s2)         [anon scope]  [above=\scopegap of s1]  {};
            \node (broil ref)  [reference]   [right=of s2]            {\sized{broil}};
            \node (s3)         [anon scope]  [above=\scopegap of s2]  {};
            \node (fry)        [definition]  [right=of s3]  [highlight node on=<1->] {\sized{fry}};
            \node (s4)         [anon scope]  [above=\scopegap of s3]  {};
            \node (broil def)  [definition]  [right=of s4]            {\sized{broil}};
            \node (s5)         [anon scope]  [above=\scopegap of s4]  {};

            \path [-Stealth]
              (root)      edge (a)
              (a)         edge (dot)
              (dot)       edge (s1)
              (s1)        edge (s2)
              (broil ref) edge [show path on=<2>] (s2)
              (s2)        edge [show path on=<3>] (s3)
              (s3)        edge (s4)
                          edge (fry)
              (s4)        edge (s5)
                          edge (broil def)
              ;
        \end{tikzpicture}
        \end{center}
    \end{column}
    \end{columns}
\end{frame}

\end{document}
