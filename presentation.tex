\documentclass[aspectratio=169]{beamer}
\mode<presentation>

\usepackage{relsize}
\usepackage{graphicx}

\usepackage{tikz}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{fit}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{shadows}
\usetikzlibrary{tikzmark}

\title{Stack Graphs}
\author{Douglas Creager}
\institute{GitHub}
\date{Strange Loop 2021}

\setbeamertemplate{navigation symbols}{}

\usepackage{minted}
\usemintedstyle{colorful}

\usepackage{fontspec}
\setsansfont{Arial}
\setmonofont[Scale=0.8]{Iosevka Term}

\newlength{\scopegap}
\setlength{\scopegap}{0.9cm}

\definecolor{sgdef}  {RGB}{159,0,0}
\definecolor{sgpop}  {RGB}{230,142,131}
\definecolor{sgref}  {RGB}{0,134,67}
\definecolor{sgpush} {RGB}{131,216,173}
\definecolor{sgjump} {RGB}{161,64,140}

\tikzset{root node/.style={
    node distance=0.5cm,
    circle, fill=black, inner sep=0pt,
    minimum size=0.35cm
}}

\tikzset{anon scope/.style={
    node distance=0.5cm,
    circle, fill=white, inner sep=0pt,
    draw=black, semithick,
    minimum size=0.35cm
}}

\tikzset{named scope/.style={
    node distance=0.5cm,
    circle, fill=white,
    draw=black, thick,
    minimum size=0.35cm
}}

\tikzset{exported scope/.style={
    node distance=0.5cm,
    circle, fill=white,
    draw=sgjump, thick, text=sgjump,
    minimum size=0.35cm
}}

\tikzset{symbol text/.style={
    fill=white,
    text height=1.5ex, text depth=0.25ex, node font=\ttfamily,
    inner xsep=7pt,
    minimum size=0.75cm,
}}

\tikzset{definition/.style={
    node distance=0.5cm,
    draw=sgdef, semithick, double, double distance=1pt, outer sep=1pt,
    text=sgdef, symbol text,
}}

\tikzset{pop/.style={
    node distance=0.5cm,
    rectangle split,
    rectangle split parts=2,
    rectangle split horizontal,
    rectangle split draw splits=false,
    rectangle split ignore empty parts,
    draw=sgpop, thick, dash dot,
    text=sgpop, symbol text,
}}
\newcommand{\popscope}{
    \nodepart{two}
    \hspace{-12pt}
    \tikz \node [circle, fill=sgjump, inner sep=0pt, minimum size=0.25cm] {};
}

\tikzset{reference/.style={
    node distance=0.5cm,
    draw=sgref, thick,
    text=sgref, symbol text,
}}

\tikzset{push/.style={
    node distance=0.5cm,
    rectangle split,
    rectangle split parts=2,
    rectangle split horizontal,
    rectangle split draw splits=false,
    rectangle split ignore empty parts,
    draw=sgpush, thick, densely dashed,
    text=sgpush, symbol text,
}}
\newcommand{\pushscope}[1]{
    \nodepart{two}
    \hspace{-12pt}
    \tikz \node [
        circle, fill=white,
        draw=sgjump,
        text=sgjump, inner sep=2pt,
        minimum size=0.25cm
    ] {\tiny #1};
}

\newcommand{\widestsymbol}{}
\newcommand{\setwidestsymbol}[1]{\renewcommand{\widestsymbol}{#1}}
\newcommand{\sized}[2][\widestsymbol]{\makebox[\widthof{#1}]{#2}}

\tikzset{
  alt/.code args={<#1>#2#3}{%
    \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
  }
}

\tikzset{
    highlight node/.style={
        general shadow={fill=blue, opacity=0.3},
        shadow scale=1.2, shadow xshift=0pt, shadow yshift=0pt
    }
}
\tikzset{
    highlight node on/.code args={<#1>}{%
        \alt<#1>{\pgfkeysalso{highlight node}}{}%
    }
}

% Animating paths in a stack graph picture
%   Just add [highlighted on=<slide>] to an edge's style.  The line of the edge
%   will be blue and extra thick on <slide> AND ALL LATER SLIDES.  It will have
%   an arrowhead on SLIDE.
%
%   Together, this means that you add this to all of the edges that comprise a
%   path, with increasing <slide> values for each one, and beamer will create an
%   overlay animation showing the edges of the path get highlighted in order
%   each time you advance to the next slide.
\tikzset{highlight edge/.style={line width=2pt, blue, -}}
\tikzset{highlight edge frontier/.style={-{Triangle[length=4pt,width=4pt]}}}
\tikzset{
    show path on/.code args={<#1>}{%
        \alt<#1- >{\pgfkeysalso{highlight edge}}{}%
        \alt<#1  >{\pgfkeysalso{highlight edge frontier}}{}%
    }
}

\tikzset{
    highlight inner edge on/.code args={<#1>}{%
        \alt<#1>{\pgfkeysalso{highlight edge}}{}%
    }
}
\tikzset{
    highlight end edge on/.code args={<#1>}{%
        \alt<#1>{\pgfkeysalso{highlight edge, highlight edge frontier}}{}%
    }
}

\tikzset{binding arrow/.style={->, red, thick, -{Triangle[]}}}

\newcommand{\codeline}[3][]{%
    \tikz[remember picture] \draw [overlay, binding arrow, #1] (#2) -- (#3);%
}

\newcommand{\curvecodeline}[4][]{%
    \tikz[remember picture] \draw [overlay, binding arrow, #1] (#2) .. controls #3 .. (#4);%
}

\newcommand{\highlightdef}[1]{%
    \tikz[remember picture]
      \draw [overlay, draw=none, fill=red!25]
        ([xshift=-1pt, yshift=8pt] pic cs:#1_start)
        rectangle
        ([xshift=1pt, yshift=-2pt] pic cs:#1_end)
        ;%
}

\newcommand{\highlightboth}[1]{%
    \tikz[remember picture]
      \draw [overlay, draw=brown, thin, fill=yellow!25]
        ([xshift=-1pt, yshift=8pt] pic cs:#1_start)
        rectangle
        ([xshift=1pt, yshift=-2pt] pic cs:#1_end)
        ;%
}

\newcommand{\highlightref}[1]{%
    \tikz[remember picture]
      \draw [overlay, draw=none, fill=blue!25]
        ([xshift=-1pt, yshift=8pt] pic cs:#1_start)
        rectangle
        ([xshift=1pt, yshift=-2pt] pic cs:#1_end)
        ;
}


\makeatletter
\tikzset{
    tikzmark suffix=-\theframenumber-\the\beamer@slideinframe
}
\makeatother

\newcommand{\symbolstack}[1]{$\langle \texttt{#1} \rangle$}
\newcommand{\currentsymbolstack}[1]{\textsmaller[2]{Symbol stack:} \symbolstack{#1}}

\newcommand{\partialpath}[4]{
    \symbolstack{#1}
    \hspace{0.01em}
    \scalebox{0.75}{\tikz[baseline={([yshift=-0.7ex] current bounding box.center)}] #2;}
    â†’
    \scalebox{0.75}{\tikz[baseline={([yshift=-0.7ex] current bounding box.center)}] #3;}
    \hspace{0.01em}
    \symbolstack{#4}
}

\begin{document}

\begin{frame}
    \titlepage
\end{frame}


\section{Code Navigation}

\begin{frame}
    \sectionpage
\end{frame}

% easy
\begin{frame}[fragile]
    \frametitle{Code Navigation}
    \uncover<2-3>{\highlightdef{def}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      {[yshift=8pt] pic cs:ref_end}%
      {+(25:2cm) and +(-45:1cm)}%
      {[yshift=-4pt] pic cs:def_end}%
    }%
\end{frame}


\section{Why is this hard?}

\begin{frame}
    \sectionpage
\end{frame}


% easy_shadowed
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \uncover<2-3>{\highlightdef{def1}}
    \uncover<2-3>{\highlightdef{def2}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def ?\tikzmark{def1_start}?broil?\tikzmark{def1_end}?():
            pass

        def ?\tikzmark{def2_start}?broil?\tikzmark{def2_end}?():
            pass

        def saute():
            pass

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      [dotted]%
      {[yshift=8pt] pic cs:ref_end}%
      {+(15:3cm) and +(-35:1cm)}%
      {[yshift=-4pt] pic cs:def1_end}%
    }%
    \uncover<3>{\curvecodeline%
      {[yshift=8pt] pic cs:ref_end}%
      {+(25:2cm) and +(-45:1cm)}%
      {[yshift=-4pt] pic cs:def2_end}%
    }%
\end{frame}


% easy_shadowed_rust
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \uncover<2-3>{\highlightdef{def1}}
    \uncover<2-3>{\highlightdef{def2}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.rs,escapeinside=??]{rust}
        fn ?\tikzmark{def1_start}?broil?\tikzmark{def1_end}?() {}

        fn ?\tikzmark{def2_start}?broil?\tikzmark{def2_end}?() {}

        fn saute() {}

        fn main() {
          ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?();
        }
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{%
        \tikz[remember picture]
          \node [overlay, text=red]
            at ([xshift=-2ex, yshift=0.5ex] pic cs:def2_end)
            {\textbf{\Huge X}};%
    }%
\end{frame}


% separate_files
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \uncover<2-3>{\highlightdef{def}}
    \uncover<  3>{\highlightboth{import}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}[t]{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{import_start}?broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:import_start}%
    }
    \uncover<3>{\curvecodeline%
      {[xshift=12pt, yshift=10pt] pic cs:import_start}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def_end}%
    }
\end{frame}


% separate_files_star
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \uncover<2-3>{\highlightdef{def}}
    \uncover<  3>{\highlightboth{import}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}[t]{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{import_start}?*?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-105:1cm)}%
      {[xshift=1pt, yshift=-2pt] pic cs:import_start}%
    }
    \uncover<3>{\curvecodeline%
      {[xshift=3pt, yshift=10pt] pic cs:import_start}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def_end}%
    }
\end{frame}


% three_files
\begin{frame}[fragile]
    \uncover<2-3>{\highlightdef{def}}
    \uncover<  3>{\highlightboth{kitchen_import}}
    \uncover<  3>{\highlightboth{chef_import}}
    \uncover<2-3>{\highlightref{ref}}
    \frametitle{Why is this hard?}
    \begin{center}
    \begin{minipage}[t]{22.5em}
    \begin{center}
        \includegraphics[height=2em]{images/pan.png}
    \end{center}
    \vskip -1em
    \begin{minipage}[t]{7em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{15em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{kitchen_import_start}?*?\tikzmark{kitchen_import_end}?
    \end{minted}
    \end{minipage}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{12em}
    \vskip 8em
    \begin{center}
        \includegraphics[height=2em]{images/chef.png}
    \end{center}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=chef.py,escapeinside=??]{python}
        from kitchen import ?\tikzmark{chef_import_start}?broil?\tikzmark{chef_import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:chef_import_start}%
    }
    \uncover<3>{\curvecodeline%
      [-]%
      {[xshift=10pt, yshift=10pt] pic cs:chef_import_start}%
      {+(90:5cm) and +(75:2cm)}%
      {[xshift=4pt, yshift=10pt] pic cs:kitchen_import_start}%
    }
    \uncover<3>{\curvecodeline%
      {[xshift=1pt, yshift=-4pt] pic cs:kitchen_import_start}%
      {+(-105:1cm) and +(75:1cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def_end}%
    }
\end{frame}


% three_files_updated
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \uncover<2-3>{\highlightdef{def1}}
    \uncover<2-3>{\highlightdef{def2}}
    \uncover<  3>{\highlightboth{import}}
    \uncover<2-3>{\highlightref{ref}}
    \begin{center}
    \begin{minipage}[t]{22.5em}
    \begin{center}
        \includegraphics[height=2em]{images/pan.png}
    \end{center}
    \vskip -1em
    \begin{minipage}[t]{7em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def1_start}?broil?\tikzmark{def1_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{15em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import *

        def ?\tikzmark{def2_start}?broil?\tikzmark{def2_end}?():
            print("We're broiling!")
            import stove
            return stove.broil()
    \end{minted}
    \end{minipage}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{12em}
    \vskip 8em
    \begin{center}
        \includegraphics[height=2em]{images/chef.png}
    \end{center}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=chef.py,escapeinside=??]{python}
        from kitchen import ?\tikzmark{import_start}?broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:import_start}%
    }
    \uncover<3>{\curvecodeline%
      {[xshift=10pt, yshift=10pt] pic cs:import_start}%
      {+(90:5cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def2_end}%
    }
\end{frame}


% python_class
\begin{frame}[fragile]
    \frametitle{Why is this hard?}
    \begin{center}
    \uncover<2- >{\highlightdef{def}}%
    \uncover<2- >{\highlightref{ref}}%
    \begin{minipage}[t]{25.5em}
    \begin{center}
        \includegraphics[height=2em]{images/pan.png}
    \end{center}
    \vskip -1em
    \begin{minipage}[t]{10em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        class?\tikzmark{class}? Stove?\tikzmark{class_def}?(object):
            def bake():
                pass

            def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
                pass

            def saute():
                pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{15em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{kitchen_import}?*
    \end{minted}
    \end{minipage}
    \end{minipage}
    \hspace{-5.5em}
    \begin{minipage}[t]{12em}
    \vskip 6em
    \begin{center}
        \includegraphics[height=2em]{images/chef.png}
    \end{center}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=chef.py,escapeinside=??]{python}
        from kitchen import ?\tikzmark{chef_import}?Stove

        stove?\tikzmark{instance_def}? = Stove?\tikzmark{class_ref}?()
        stove?\tikzmark{instance_ref}?.?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \uncover<3- >{\curvecodeline%
      [-, alt=<4>{line width=2pt, blue}{}]%
      {[xshift=-10pt, yshift=-3pt] pic cs:ref_end}%
      {+(-135:0.2cm) and +(-45:0.2cm)}%
      {[xshift=-10pt, yshift=-3pt] pic cs:instance_ref}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<5>{line width=2pt, blue}{}]%
      {[xshift=-23pt, yshift=2pt] pic cs:instance_ref}%
      {+(180:0.2cm) and +(180:0.2cm)}%
      {[xshift=-23pt, yshift=2pt] pic cs:instance_def}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<6>{line width=2pt, blue}{}]%
      {[xshift=-10pt, yshift=8pt] pic cs:instance_def}%
      {+(65:0.3cm) and +(115:0.3cm)}%
      {[xshift=-10pt, yshift=8pt] pic cs:class_ref}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<7>{line width=2pt, blue}{}]%
      {[xshift=-4pt, yshift=-3pt] pic cs:class_ref}%
      {+(-35:0.5cm) and +(-90:1cm)}%
      {[xshift=10pt, yshift=-3pt] pic cs:chef_import}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<8>{line width=2pt, blue}{}]%
      {[xshift=10pt, yshift=10pt] pic cs:chef_import}%
      {+(90:3cm) and +(-90:1cm)}%
      {[xshift=2pt, yshift=-3pt] pic cs:kitchen_import}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<9>{line width=2pt, blue}{}]%
      {[xshift=2pt, yshift=10pt] pic cs:kitchen_import}%
      {+(90:2cm) and +(90:2cm)}%
      {[xshift=-10pt, yshift=8pt] pic cs:class_def}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<10>{line width=2pt, blue}{}]%
      {[xshift=-6pt, yshift=-2pt] pic cs:class_def}%
      {+(-45:2cm) and +(90:2cm)}%
      {[xshift=4pt, yshift=10pt] pic cs:class_ref}%
    }
    \uncover<3- >{\curvecodeline%
      [-, alt=<11>{line width=2pt, blue}{}]%
      {[xshift=4pt, yshift=-3pt] pic cs:class_ref}%
      {+(-90:2.5cm) and +(-90:6.5cm)}%
      {[xshift=-10pt, yshift=-2pt] pic cs:class}%
    }
    \uncover<3- >{\curvecodeline%
      [alt=<12>{line width=2pt, blue}{}]%
      {[xshift=-10pt, yshift=8pt] pic cs:class}%
      {+(75:1cm) and +(115:1cm)}%
      {[xshift=-10pt, yshift=6pt] pic cs:def_end}%
    }
\end{frame}


\begin{frame}
    \textlarger{Oh is that all?} \\
    \emph{[Ed: Insert piece of cake picture here]}
\end{frame}


\begin{frame}
    \frametitle{Zero configuration}
    \begin{center}
        We don't want to have to ask the package \\ owner how to collect the data
        we need.
    \end{center}
    \begin{center}
        Or ask them to configure a job to produce that data.
    \end{center}
    \begin{center}
        We \strong{especially} can't ask an open-source maintainer \\ to expend
        effort to generate data that we need \\ for an enterprise customer!
    \end{center}
\end{frame}


\begin{frame}
    \frametitle{SCALE}
    \emph{Quote some big numbers about GitHub's scale}
\end{frame}


\begin{frame}[t]
    \frametitle{When do we do the work?}
    \vskip 2em
    \begin{tikzpicture}
        \node (bar) at(0,0) [
            rectangle, anchor=west,
            minimum width=\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=gray!20,
        ] {};

        \node at(bar.west) [
            rectangle, anchor=west, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Index};
        \node at(bar.east) [
            rectangle, anchor=east, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Query};
    \end{tikzpicture}
\end{frame}


\begin{frame}[t]
    \frametitle{When do we do the work?}
    \vskip 2em
    \begin{tikzpicture}
        \node (bar) at(0,0) [
            rectangle, anchor=west,
            minimum width=\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=gray!20,
        ] {};

        \node (query) at(bar.east) [
            rectangle, anchor=east,
            minimum width=0.8\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=blue!20,
        ] {};

        \node at (query.center) [overlay, text=red] {\scalebox{2}{\textbf{\Huge X}}};%

        \node at(bar.west) [
            rectangle, anchor=west, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Index};
        \node at(bar.east) [
            rectangle, anchor=east, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Query};
    \end{tikzpicture}

    \begin{center}
        This is an interactive feature, so we can't do too much work at query
        time.
    \end{center}
    \begin{center}
        Goal: < 100ms
    \end{center}
\end{frame}


\begin{frame}[t]
    \frametitle{When do we do the work?}
    \vskip 2em
    \begin{tikzpicture}
        \node (bar) at(0,0) [
            rectangle, anchor=west,
            minimum width=\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=gray!20,
        ] {};

        \node (index) at(bar.west) [
            rectangle, anchor=west,
            minimum width=0.8\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=yellow!20,
        ] {};

        \node at (index.center) [overlay, text=red] {\scalebox{2}{\textbf{\Huge X}}};%

        \node at(bar.west) [
            rectangle, anchor=west, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Index};
        \node at(bar.east) [
            rectangle, anchor=east, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Query};
    \end{tikzpicture}

    \begin{center}
        Because of our scale, we can't doo too much work at index time, either!

        (Compute and storage costs are too high, work is wasted, etc.)
    \end{center}
\end{frame}


\begin{frame}[t]
    \frametitle{When do we do the work?}
    \vskip 2em
    \begin{tikzpicture}
        \node (bar) at(0,0) [
            rectangle, anchor=west,
            minimum width=\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=gray!20,
        ] {};

        \node at(bar.west) [
            rectangle, anchor=west,
            minimum width=0.5\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=yellow!20,
        ] {};
        \node at(bar.east) [
            rectangle, anchor=east,
            minimum width=0.5\columnwidth, minimum height=1cm,
            draw=black, thin,
            fill=blue!20,
        ] {};

        \node at(bar.west) [
            rectangle, anchor=west, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Index};
        \node at(bar.east) [
            rectangle, anchor=east, inner xsep=2ex,
            text height=1.5ex, text depth=0.25ex,
            text=black,
        ] {Query};
    \end{tikzpicture}

    \begin{center}
        We want to strike a balance.
    \end{center}

    \begin{center}
        Precalculate as much as we can.

        Minimize the amount of \strong{duplicated} work.

        Defer \strong{some} work until query time to make that happen.
    \end{center}
\end{frame}


\begin{frame}
    \frametitle{Incremental processing}
    \begin{center}
        In a typical commit, a small fraction of files in the repo change.
    \end{center}
    \begin{center}
        We want to reuse results that we've \\ already calculated for unchanged
        files.
    \end{center}
    \begin{center}
        \emph{Structural sharing} (like git itself) helps save storage.
    \end{center}
    \begin{center}
        \emph{Incremental processing} also helps save compute.
    \end{center}
\end{frame}


\begin{frame}
    \frametitle{Why is this hard?}
    \begin{itemize}
        \item Different languages have different name binding rules.
        \item Some of those rules can be quite complex.
        \item The result might depend on intermediate files.
        \item We don't want to require manual per-repo configuration.
        \item We need incremental processing to handle our scale.
    \end{itemize}
\end{frame}


\section{Incremental results}

\begin{frame}
    \sectionpage
\end{frame}


% incremental_separate_files
\begin{frame}[fragile]
    \frametitle{What would incremental results look like?}

    \uncover<1,2,4>{\highlightdef{def}}
    \uncover<1,3,4>{\highlightboth{import}}
    \uncover<1,3,4>{\highlightref{ref}}

    \begin{center}
    \begin{minipage}{21em}
    \begin{minipage}[t]{9em}
    \begin{uncoverenv}<1,2,4>
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{uncoverenv}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{uncoverenv}<1,3,4>
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{import_start}?broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{uncoverenv}
    \end{minipage}
    \end{minipage}
    \hspace{-7em}
    \begin{minipage}[t]{0.51\textwidth}
    \vskip 1em
    \begin{center}
        \uncover<3,4>{
            The reference at \textsl{kitchen.py:3:1} \\
            refers to \texttt{stove.broil} in some other file
        }
        \\
        \uncover<4>{+}
        \\
        \uncover<2,4>{\texttt{stove.broil} is defined at \textsl{stove.py:4:5}}
        \\
        \uncover<4>{=}
        \\
        \uncover<4>{
            The reference at \textsl{kitchen.py:3:1} \\
            is defined at \textsl{stove.py:4:5}
        }
    \end{center}
    \end{minipage}
    \end{center}
    \uncover<1,3,4>{\curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:import_start}%
    }
    \uncover<1,4>{\curvecodeline%
      {[xshift=12pt, yshift=10pt] pic cs:import_start}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def_end}%
    }
\end{frame}


% incremental_python_class
\begin{frame}[fragile]
    \frametitle{What would incremental results look like?}

    \uncover<1-2,6>{\highlightref{ref}}
    \uncover<3>    {\highlightboth{mod}}
    \uncover<3>    {\highlightboth{import}}
    \uncover<4>    {\highlightboth{call}}
    \uncover<5>    {\highlightboth{member}}

    \begin{center}
    \begin{minipage}[t]{12em}
    \begin{center}
        \includegraphics[height=2em]{images/chef.png}
    \end{center}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=chef.py,escapeinside=??]{python}
        from ?\tikzmark{mod_start}?kitchen?\tikzmark{mod_end}? import ?\tikzmark{import_start}?Stove?\tikzmark{import_end}?

        stove?\tikzmark{instance_def}? = ?\tikzmark{call_start}?Stove?\tikzmark{class_ref}?()?\tikzmark{call_end}?
        stove?\tikzmark{member_start}?.?\tikzmark{ref_start}?broil?\tikzmark{ref_end}\tikzmark{member_end}?()
    \end{minted}
    \end{minipage}
    \vskip 2em
    \hspace{5em}
    \begin{minipage}[t]{0.65\textwidth}
    \uncover<3- >{If you can find what \texttt{kitchen.Stove} resolves to} \\
    \uncover<4- >{and can call it} \\
    \uncover<5- >{then the result should have a member named \texttt{broil}} \\
    \uncover<6- >{which the reference at \textsl{chef.py:4:7} resolves to.} \\
    \end{minipage}
    \end{center}
    \uncover<2- >{\curvecodeline%
      [-]%
      {[xshift=-10pt, yshift=-3pt] pic cs:ref_end}%
      {+(-135:0.2cm) and +(-45:0.2cm)}%
      {[xshift=-10pt, yshift=-3pt] pic cs:member_start}%
    }
    \uncover<2- >{\curvecodeline%
      [-]%
      {[xshift=-23pt, yshift=2pt] pic cs:member_start}%
      {+(180:0.2cm) and +(180:0.2cm)}%
      {[xshift=-23pt, yshift=2pt] pic cs:instance_def}%
    }
    \uncover<2- >{\curvecodeline%
      [-]%
      {[xshift=-10pt, yshift=8pt] pic cs:instance_def}%
      {+(65:0.3cm) and +(115:0.3cm)}%
      {[xshift=-10pt, yshift=8pt] pic cs:class_ref}%
    }
    \uncover<2- >{\curvecodeline%
      [-]%
      {[xshift=-4pt, yshift=-3pt] pic cs:class_ref}%
      {+(-35:0.5cm) and +(-90:1cm)}%
      {[xshift=10pt, yshift=-3pt] pic cs:import_start}%
    }
\end{frame}


\section{Stack graphs}

\begin{frame}
    \sectionpage
\end{frame}


\begin{frame}[fragile]
    \frametitle{Stack graphs}
    \highlightdef{def}
    \highlightboth{import}
    \highlightref{ref}
    \begin{center}
    \begin{minipage}[t]{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=stove.py,escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{0.5em}
    \begin{minipage}[t]{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        from stove import ?\tikzmark{import_start}?broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \end{center}
    \curvecodeline%
      [-]%
      {[yshift=10pt] pic cs:ref_end}%
      {+(45:1cm) and +(-155:1cm)}%
      {[yshift=-4pt] pic cs:import_start}%
    \curvecodeline%
      {[xshift=12pt, yshift=10pt] pic cs:import_start}%
      {+(90:2cm) and +(75:2cm)}%
      {[xshift=-6pt, yshift=10pt] pic cs:def_end}%
\end{frame}


\begin{frame}[fragile]
    \frametitle{Stack graphs}

    \uncover<3>{\highlightdef{def}}
    \uncover<5>{\highlightdef{mod}}

    \begin{center}

    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label={\tikzmark{mod_start}stove.py\tikzmark{mod_end}},escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{2em}
    \begin{uncoverenv}<2- >
    \begin{tikzpicture}[baseline={(current bounding box.center)}]
        \node (root)       [highlight node on=<5>]
                           [root node]                            {};
        \node (stove)      [highlight node on=<5>]
                           [definition]  [left=of root]           {stove};
        \node (dot)        [highlight node on=<5>]
                           [pop]         [left=of stove]          {.};
        \node (s1)         [highlight node on=<4>]
                           [anon scope]  [left=of dot]            {};

        \setwidestsymbol{broil}
        \node (s2)         [highlight node on=<4>]
                           [anon scope]  [above=\scopegap of s1]  {};
        \node (saute def)  [definition]  [left=of s2]             {\sized{saute}};
        \node (s3)         [highlight node on=<4>]
                           [anon scope]  [above=\scopegap of s2]  {};
        \node (broil def)  [highlight node on=<3>]
                           [definition]  [left=of s3]             {\sized{broil}};
        \node (s4)         [highlight node on=<4>]
                           [anon scope]  [above=\scopegap of s3]  {};
        \node (bake def)   [definition]  [left=of s4]             {\sized{bake}};
        \node (s5)         [highlight node on=<4>]
                           [anon scope]  [above=\scopegap of s4]  {};

        \path [-Stealth]
          (root)      edge (stove)
          (stove)     edge (dot)
          (dot)       edge (s1)
          (s1)        edge (s2)
          (s2)        edge (s3)
                      edge (saute def)
          (s3)        edge (s4)
                      edge (broil def)
          (s4)        edge (s5)
                      edge (bake def)
          ;
    \end{tikzpicture}
    \end{uncoverenv}

    \end{center}
\end{frame}


\begin{frame}[fragile]
    \frametitle{Stack graphs}

    \uncover<3>{\highlightref{ref}}
    \uncover<4>{\highlightboth{import}}

    \begin{center}

    \begin{minipage}{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        ?\tikzmark{import_start}?from stove import broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \hspace{-7em}
    \begin{uncoverenv}<2- >
    \begin{tikzpicture}[baseline={([yshift=2em] current bounding box.center)}]
        \node (root)       [highlight node on=<4>]
                           [root node]                            {};
        \node (kitchen)    [definition]  [right=of root]          {kitchen};
        \node (dot)        [pop]         [right=of kitchen]       {.};
        \node (k1)         [anon scope]  [right=of dot]           {};

        \node (k2)         [anon scope]  [above=\scopegap of k1]  {};
        \node (broil ref)  [highlight node on=<3>]
                           [reference]   [right=of k2]            {broil};
        \node (k3)         [anon scope]  [above=\scopegap of k2]  {};
        \node (import def) [highlight node on=<4>]
                           [pop]         [right=of k3]            {broil};
        \node (import ref) [highlight node on=<4>]
                           [push]        [right=of import def]    {broil};
        \node (import dot) [highlight node on=<4>]
                           [push]        [right=of import ref]    {.};
        \node (import mod) [highlight node on=<4>]
                           [push]        [right=of import dot]    {stove};
        \node (k4)         [anon scope]  [above=\scopegap of k3]  {};

        \path [-Stealth]
          (root)      edge (kitchen)
          (kitchen)    edge (dot)
          (dot)        edge (k1)
          (k1)         edge (k2)
          (broil ref)  edge (k2)
          (k2)         edge (k3)
          (k3)         edge (k4)
                       edge (import def)
          (import def) edge (import ref)
          (import ref) edge (import dot)
          (import dot) edge (import mod)
          (import mod) edge [overlay, in control=+(-60:3cm), out control=+(-90:4cm)] (root)
          ;
    \end{tikzpicture}
    \end{uncoverenv}

    \end{center}
\end{frame}


% Combined

\begin{frame}[fragile]
    \frametitle{Stack graphs}
    \begin{center}
    \scalebox{0.75}{
    \begin{tikzpicture}
        \node (root)       [highlight node on={<2,3,13>}]
                           [root node]                            {};
        \node (stove)      [highlight node on={<2,14>}]
                           [definition]  [left=of root]           {stove};
        \node (dot)        [highlight node on={<2,15>}]
                           [pop]         [left=of stove]          {.};
        \node (s1)         [highlight node on={<2,16>}]
                           [anon scope]  [left=of dot]            {};

        \setwidestsymbol{broil}
        \node (s2)         [highlight node on={<2,17>}]
                           [anon scope]  [above=\scopegap of s1]  {};
        \node (saute def)  [highlight node on=<2>]
                           [definition]  [left=of s2]             {\sized{saute}};
        \node (s3)         [highlight node on={<2,18>}]
                           [anon scope]  [above=\scopegap of s2]  {};
        \node (broil def)  [highlight node on={<2,4,19>}]
                           [definition]  [left=of s3]             {\sized{broil}};
        \node (s4)         [highlight node on=<2>]
                           [anon scope]  [above=\scopegap of s3]  {};
        \node (bake def)   [highlight node on=<2>]
                           [definition]  [left=of s4]             {\sized{bake}};
        \node (s5)         [highlight node on=<2>]
                           [anon scope]  [above=\scopegap of s4]  {};

        \path [-Stealth]
          (root)      edge [highlight inner edge on=<4>, show path on=<14>] (stove)
          (stove)     edge [highlight inner edge on=<4>, show path on=<15>] (dot)
          (dot)       edge [highlight inner edge on=<4>, show path on=<16>] (s1)
          (s1)        edge [highlight inner edge on=<4>, show path on=<17>] (s2)
          (s2)        edge [highlight inner edge on=<4>, show path on=<18>] (s3)
                      edge (saute def)
          (s3)        edge (s4)
                      edge [highlight end edge on=<4>, show path on=<19>]   (broil def)
          (s4)        edge (s5)
                      edge (bake def)
          ;

        \node (kitchen)    [highlight node on=<3>]
                           [definition]  [right=of root]          {kitchen};
        \node (dot)        [highlight node on=<3>]
                           [pop]         [right=of kitchen]       {.};
        \node (k1)         [highlight node on=<3>]
                           [anon scope]  [right=of dot]           {};

        \node (k2)         [highlight node on={<3,7>}]
                           [anon scope]  [above=\scopegap of k1]  {};
        \node (broil ref)  [highlight node on={<3,4,6>}]
                           [reference]   [right=of k2]            {broil};
        \node (k3)         [highlight node on={<3,8>}]
                           [anon scope]  [above=\scopegap of k2]  {};
        \node (import def) [highlight node on={<3,9>}]
                           [pop]         [right=of k3]            {broil};
        \node (import ref) [highlight node on={<3,10>}]
                           [push]        [right=of import def]    {broil};
        \node (import dot) [highlight node on={<3,11>}]
                           [push]        [right=of import ref]    {.};
        \node (import mod) [highlight node on={<3,12>}]
                           [push]        [right=of import dot]    {stove};
        \node (k4)         [highlight node on=<3>]
                           [anon scope]  [above=\scopegap of k3]  {};

        \path [-Stealth]
          (root)      edge (kitchen)
          (kitchen)    edge (dot)
          (dot)        edge (k1)
          (k1)         edge (k2)
          (broil ref)  edge [highlight inner edge on=<4>, show path on=<7>] (k2)
          (k2)         edge [highlight inner edge on=<4>, show path on=<8>] (k3)
          (k3)         edge (k4)
                       edge [highlight inner edge on=<4>, show path on=<9>] (import def)
          (import def) edge [highlight inner edge on=<4>, show path on=<10>] (import ref)
          (import ref) edge [highlight inner edge on=<4>, show path on=<11>] (import dot)
          (import dot) edge [highlight inner edge on=<4>, show path on=<12>] (import mod)
          (import mod) edge [overlay, in control=+(-60:3cm), out control=+(-90:4cm)]
                            [highlight inner edge on=<4>, show path on=<13>] (root)
          ;
    \end{tikzpicture}
    }
    \vskip 2em
    \begin{minipage}{0.5\textwidth}
    \begin{overprint}
        \onslide<6-8,10,15-18> \currentsymbolstack{broil}
        \onslide<5,9,19>       \currentsymbolstack{}
        \onslide<11,14>        \currentsymbolstack{.broil}
        \onslide<12-13>        \currentsymbolstack{stove.broil}
    \end{overprint}
    \end{minipage}
    \end{center}
\end{frame}


\begin{frame}[fragile]
    \frametitle{Partial paths}

    \begin{center}

    \begin{minipage}{11em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label=kitchen.py,escapeinside=??]{python}
        ?\tikzmark{import_start}?from stove import broil?\tikzmark{import_end}?

        ?\tikzmark{ref_start}?broil?\tikzmark{ref_end}?()
    \end{minted}
    \end{minipage}
    \hspace{2em}
    \scalebox{0.75}{
    \begin{tikzpicture}[baseline={([yshift=-2em] current bounding box.center)}]
        \node (root)       [root node]                            {};
        \node (kitchen)    [definition]  [right=of root]          {kitchen};
        \node (dot)        [pop]         [right=of kitchen]       {.};
        \node (k1)         [anon scope]  [right=of dot]           {};

        \node (k2)         [anon scope]  [above=\scopegap of k1]  {};
        \node (broil ref)  [reference]   [right=of k2]            {broil};
        \node (k3)         [anon scope]  [above=\scopegap of k2]  {};
        \node (import def) [pop]         [right=of k3]            {broil};
        \node (import ref) [push]        [right=of import def]    {broil};
        \node (import dot) [push]        [right=of import ref]    {.};
        \node (import mod) [push]        [right=of import dot]    {stove};
        \node (k4)         [anon scope]  [above=\scopegap of k3]  {};

        \path [-Stealth]
          (root)      edge (kitchen)
          (kitchen)    edge (dot)
          (dot)        edge (k1)
          (k1)         edge (k2)
          (broil ref)  edge [highlight inner edge on=<2- >] (k2)
          (k2)         edge [highlight inner edge on=<2- >] (k3)
          (k3)         edge (k4)
                       edge [highlight inner edge on=<2- >] (import def)
          (import def) edge [highlight inner edge on=<2- >] (import ref)
          (import ref) edge [highlight inner edge on=<2- >] (import dot)
          (import dot) edge [highlight inner edge on=<2- >] (import mod)
          (import mod) edge [highlight end edge on=<2- >]
                            [overlay, in control=+(-60:3cm), out control=+(-90:4cm)] (root)
          ;
    \end{tikzpicture}
    }

    \vskip 5em
    \uncover<3- >{\partialpath{\$1}{\node [reference] {broil}}{\node [root node] {}}{stove.broil \$1}}
    \vskip 0.75em
    \uncover<4>{The reference at \textsl{kitchen.py:3:1}  refers to \texttt{stove.broil} in some other file}

    \end{center}
\end{frame}


\begin{frame}[fragile]
    \frametitle{Partial paths}

    \begin{center}

    \begin{minipage}{9em}
    \begin{minted}[autogobble,frame=single,framesep=6pt,label={\tikzmark{mod_start}stove.py\tikzmark{mod_end}},escapeinside=??]{python}
        def bake():
            pass

        def ?\tikzmark{def_start}?broil?\tikzmark{def_end}?():
            pass

        def saute():
            pass
    \end{minted}
    \end{minipage}
    \hspace{2em}
    \scalebox{0.75}{
    \begin{tikzpicture}[baseline={(current bounding box.center)}]
        \node (root)       [root node]                            {};
        \node (stove)      [definition]  [left=of root]           {stove};
        \node (dot)        [pop]         [left=of stove]          {.};
        \node (s1)         [anon scope]  [left=of dot]            {};

        \setwidestsymbol{broil}
        \node (s2)         [anon scope]  [above=\scopegap of s1]  {};
        \node (saute def)  [definition]  [left=of s2]             {\sized{saute}};
        \node (s3)         [anon scope]  [above=\scopegap of s2]  {};
        \node (broil def)  [definition]  [left=of s3]             {\sized{broil}};
        \node (s4)         [anon scope]  [above=\scopegap of s3]  {};
        \node (bake def)   [definition]  [left=of s4]             {\sized{bake}};
        \node (s5)         [anon scope]  [above=\scopegap of s4]  {};

        \path [-Stealth]
          (root)      edge [highlight inner edge on=<2- >] (stove)
          (stove)     edge [highlight inner edge on=<2- >] (dot)
          (dot)       edge [highlight inner edge on=<2- >] (s1)
          (s1)        edge [highlight inner edge on=<2- >] (s2)
          (s2)        edge [highlight inner edge on=<2- >] (s3)
                      edge (saute def)
          (s3)        edge (s4)
                      edge [highlight end edge on=<2- >] (broil def)
          (s4)        edge (s5)
                      edge (bake def)
          ;
    \end{tikzpicture}
    }

    \vskip 2em
    \uncover<3- >{\partialpath{stove.broil}{\node [root node] {}}{\node [definition] {broil}}{}}
    \vskip 0.75em
    \uncover<4>{\texttt{stove.broil} is defined at \textsl{stove.py:4:5}}

    \end{center}
\end{frame}


\begin{frame}
    \begin{center}
        \begin{tikzpicture}
            \draw [help lines] (0,0) grid (10,8);

            \node (root)   [root node]       at(1,1)  {};
            \node (s0)     [anon scope]      at(2,1)  {};
            \node (sB)     [named scope]     at(3,1)  {B};
            \node (s7)     [exported scope]  at(4,1)  {7};
            \node (A)      [definition]      at(1,2)  {A};

            \node (a)      [definition]  [right=of A] {a};
            \node (A2)     [pop]         [above=of A] {A\textsubscript{2}};
            \node (main2)  [pop]         [right=of A2] {\_\_main\_\_\textsubscript{2}};
            \node (bar)    [pop]         [right=of main2] {A\textsubscript{3} \popscope};

            \node (A3)     [reference]  [above=of A2] {A};
            \node (a3)     [reference]  [right=of A3] {a};
            \node (A4)     [push]       [above=of A3] {A\textsubscript{4}};
            \node (main4)  [push]       [right=of A4] {\_\_main\_\_\textsubscript{4}};
            \node (foo)    [push]       [right=of main4] {A\textsubscript{3} \pushscope{7}};

            % edges
            \path [-Stealth]
              (root) edge (A)
              (A) edge (a)
                  edge (A2)
              (a) edge (main2)
              ;
        \end{tikzpicture}
    \end{center}
\end{frame}

\end{document}
